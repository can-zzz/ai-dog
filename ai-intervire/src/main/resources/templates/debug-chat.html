<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•èŠå¤©é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; display: flex; gap: 20px; }
        .chat-section { flex: 1; background: white; padding: 20px; border-radius: 8px; }
        .debug-section { flex: 1; background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .message { margin: 10px 0; padding: 10px; border-radius: 8px; }
        .user { background: #007bff; color: white; text-align: right; }
        .assistant { background: #e9ecef; color: #333; }
        .input-group { display: flex; gap: 10px; margin-top: 20px; }
        .input-group input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .debug-log { height: 400px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px; }
        .stream-content { display: inline; }
        .stream-cursor { display: inline; animation: blink 1s infinite; color: #007bff; font-weight: bold; }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }
        .streaming-complete .stream-cursor { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-section">
            <h2>èŠå¤©åŒºåŸŸ</h2>
            <div id="chatMessages">
                <div class="message assistant">
                    ä½ å¥½ï¼æˆ‘æ˜¯AIæ™ºèƒ½åŠ©æ‰‹è°ƒè¯•ç‰ˆæœ¬ã€‚è¯·è¾“å…¥æ¶ˆæ¯æµ‹è¯•æµå¼è¾“å‡ºã€‚
                </div>
            </div>
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." value="ä½ å¥½ï¼Œè¯·ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±">
                <button id="sendBtn" class="btn" onclick="sendMessage()">å‘é€</button>
            </div>
        </div>
        
        <div class="debug-section">
            <h2>è°ƒè¯•ä¿¡æ¯</h2>
            <div id="debugLog" class="debug-log">è°ƒè¯•æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...\n</div>
            <button class="btn" onclick="clearDebug()" style="margin-top: 10px;">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script th:inline="javascript">
        const sessionId = /*[[${sessionId}]]*/ 'debug-session';
        let isProcessing = false;
        let debugLog = document.getElementById('debugLog');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearDebug() {
            debugLog.textContent = '';
            log('è°ƒè¯•æ—¥å¿—å·²æ¸…é™¤');
        }
        
        function addMessage(type, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function sendMessage() {
            if (isProcessing) {
                log('âŒ æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...');
                return;
            }
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                log('âŒ æ¶ˆæ¯ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            log(`ğŸš€ å¼€å§‹å‘é€æ¶ˆæ¯: "${message}"`);
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            
            // è®¾ç½®å¤„ç†çŠ¶æ€
            isProcessing = true;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'å¤„ç†ä¸­...';
            
            // åˆ›å»ºæµå¼å“åº”å®¹å™¨
            const chatMessages = document.getElementById('chatMessages');
            const streamingDiv = document.createElement('div');
            streamingDiv.className = 'message assistant';
            streamingDiv.innerHTML = '<span class="stream-content"></span><span class="stream-cursor">|</span>';
            chatMessages.appendChild(streamingDiv);
            
            let accumulatedText = '';
            
            log('ğŸ“¡ å‡†å¤‡å‘é€HTTPè¯·æ±‚...');
            
            fetch('/api/stream/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify({
                    message: message,
                    sessionId: sessionId,
                    saveHistory: false,
                    enableDeepThinking: false
                })
            })
            .then(response => {
                log(`ğŸ“¥ HTTPå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                log(`ğŸ“¥ Content-Type: ${response.headers.get('content-type')}`);
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                let buffer = '';
                let chunkCount = 0;
                
                function processStream() {
                    return reader.read().then(({done, value}) => {
                        if (done) {
                            log('âœ… æµå¼ä¼ è¾“å®Œæˆ');
                            finishStreaming();
                            resetSendButton();
                            return;
                        }
                        
                        chunkCount++;
                        const chunk = new TextDecoder().decode(value);
                        buffer += chunk;
                        
                        log(`ğŸ“¦ æ¥æ”¶æ•°æ®å— #${chunkCount}: ${chunk.length} å­—èŠ‚`);
                        log(`ğŸ“¦ åŸå§‹æ•°æ®: ${JSON.stringify(chunk.substring(0, 100))}${chunk.length > 100 ? '...' : ''}`);
                        
                        // å¤„ç†å®Œæ•´çš„SSEæ¶ˆæ¯
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';
                        
                        log(`ğŸ” å¤„ç† ${lines.length} è¡Œæ•°æ®`);
                        
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i];
                            log(`ğŸ” ç¬¬${i+1}è¡Œ: "${line}"`);
                            
                            if (line.startsWith('data:')) {
                                try {
                                    const jsonData = line.substring(5).trim();
                                    if (jsonData === '') {
                                        log('âš ï¸ ç©ºæ•°æ®è¡Œï¼Œè·³è¿‡');
                                        continue;
                                    }
                                    
                                    log(`ğŸ” JSONæ•°æ®: ${jsonData}`);
                                    const data = JSON.parse(jsonData);
                                    log(`âœ… è§£ææˆåŠŸ: ${JSON.stringify(data)}`);
                                    
                                    // è¯¦ç»†æ£€æŸ¥æ•°æ®ç»“æ„
                                    log(`ğŸ” æ•°æ®æ£€æŸ¥:`);
                                    log(`   - error: ${data.error} (${typeof data.error})`);
                                    log(`   - done: ${data.done} (${typeof data.done})`);
                                    log(`   - content: ${JSON.stringify(data.content)} (${typeof data.content})`);
                                    log(`   - hasOwnProperty('content'): ${data.hasOwnProperty('content')}`);
                                    
                                    if (data.error) {
                                        log(`âŒ æ¥æ”¶åˆ°é”™è¯¯: ${data.error}`);
                                        streamingDiv.innerHTML = `<span style="color: red;">é”™è¯¯: ${data.error}</span>`;
                                        resetSendButton();
                                        return;
                                    }
                                    
                                    if (data.hasOwnProperty('content')) {
                                        log(`ğŸ“ å¤„ç†å†…å®¹: "${data.content}"`);
                                        if (data.content !== null) {
                                            accumulatedText += data.content;
                                            log(`ğŸ“ ç´¯ç§¯å†…å®¹: "${accumulatedText}" (é•¿åº¦: ${accumulatedText.length})`);
                                            
                                            // æ›´æ–°æ˜¾ç¤º
                                            const contentSpan = streamingDiv.querySelector('.stream-content');
                                            contentSpan.textContent = accumulatedText;
                                            log(`âœ… æ›´æ–°DOMæ˜¾ç¤º: "${contentSpan.textContent}"`);
                                        } else {
                                            log(`ğŸ“ contentä¸ºnullï¼Œä¸ç´¯ç§¯`);
                                        }
                                    } else {
                                        log(`âš ï¸ æ•°æ®å¯¹è±¡ä¸åŒ…å«contentå±æ€§`);
                                    }
                                    
                                    if (data.done) {
                                        log('ğŸ æ¥æ”¶åˆ°å®Œæˆæ ‡å¿—');
                                        finishStreaming();
                                        resetSendButton();
                                        return;
                                    }
                                    
                                } catch (e) {
                                    log(`âŒ JSONè§£æé”™è¯¯: ${e.message}`);
                                    log(`âŒ åŸå§‹æ•°æ®: ${jsonData}`);
                                }
                            } else if (line.trim()) {
                                log(`âš ï¸ édataè¡Œ: "${line}"`);
                            }
                        }
                        
                        return processStream();
                    });
                }
                
                log('ğŸ”„ å¼€å§‹å¤„ç†æµ...');
                return processStream();
            })
            .catch(error => {
                log(`âŒ è¯·æ±‚é”™è¯¯: ${error.message}`);
                streamingDiv.innerHTML = `<span style="color: red;">ç½‘ç»œé”™è¯¯: ${error.message}</span>`;
                resetSendButton();
            });
            
            messageInput.value = '';
        }
        
        function finishStreaming() {
            log('ğŸ¯ å®Œæˆæµå¼è¾“å‡º');
            const streamingDiv = document.querySelector('.message.assistant:last-child');
            if (streamingDiv) {
                const cursor = streamingDiv.querySelector('.stream-cursor');
                if (cursor) {
                    cursor.remove();
                    log('ğŸ¯ ç§»é™¤å…‰æ ‡');
                }
                streamingDiv.classList.add('streaming-complete');
            }
        }
        
        function resetSendButton() {
            log('ğŸ”„ é‡ç½®å‘é€æŒ‰é’®');
            isProcessing = false;
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = false;
            sendBtn.textContent = 'å‘é€';
        }
        
        // å›è½¦å‘é€
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        log('ğŸš€ è°ƒè¯•èŠå¤©é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>
