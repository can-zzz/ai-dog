<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI智能助手 - 简化聊天</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
        }
        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.assistant {
            background: #f8f9fa;
            color: #333;
        }
        .chat-input {
            padding: 20px;
            border-top: 1px solid #dee2e6;
        }
        .stream-cursor {
            display: inline;
            animation: blink 1s infinite;
            color: #007bff;
            font-weight: bold;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="bg-primary text-white p-3">
            <h1 class="mb-0">AI智能助手 - 简化版</h1>
            <small th:text="'会话ID: ' + ${sessionId}">会话ID: </small>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                你好！我是AI智能助手，很高兴为您服务。
            </div>
        </div>
        
        <div class="chat-input">
            <div class="input-group">
                <input type="text" id="messageInput" class="form-control" placeholder="请输入您的问题...">
                <button id="sendButton" class="btn btn-primary" onclick="sendMessage()">发送</button>
            </div>
        </div>
    </div>
    
    <script th:inline="javascript">
        const sessionId = /*[[${sessionId}]]*/ 'default-session';
        let isProcessing = false;
        
        function sendMessage() {
            if (isProcessing) return;
            
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // 显示用户消息
            addMessage('user', message);
            
            // 清空输入框
            messageInput.value = '';
            
            // 设置处理状态
            isProcessing = true;
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = '处理中...';
            
            // 创建流式响应容器
            const streamingDiv = createStreamingMessage();
            let accumulatedText = '';
            
            // 发送请求
            fetch('/api/stream/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify({
                    message: message,
                    sessionId: sessionId,
                    saveHistory: true,
                    enableDeepThinking: false
                })
            })
            .then(response => {
                const reader = response.body.getReader();
                let buffer = '';
                
                function processStream() {
                    return reader.read().then(({done, value}) => {
                        if (done) {
                            // 完成流式输出
                            finishStreaming(streamingDiv);
                            resetSendButton();
                            return;
                        }
                        
                        const chunk = new TextDecoder().decode(value);
                        buffer += chunk;
                        
                        // 处理SSE消息
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                try {
                                    const jsonData = line.substring(5).trim();
                                    if (jsonData === '') continue;
                                    
                                    const data = JSON.parse(jsonData);
                                    
                                    if (data.error) {
                                        streamingDiv.innerHTML = `<span style="color: red;">错误: ${data.error}</span>`;
                                        resetSendButton();
                                        return;
                                    }
                                    
                                    if (data.hasOwnProperty('content')) {
                                        accumulatedText += data.content;
                                        updateStreamingContent(streamingDiv, accumulatedText);
                                    }
                                    
                                    if (data.done) {
                                        finishStreaming(streamingDiv);
                                        resetSendButton();
                                        return;
                                    }
                                    
                                } catch (e) {
                                    console.error('JSON解析错误:', e);
                                }
                            }
                        }
                        
                        return processStream();
                    });
                }
                
                return processStream();
            })
            .catch(error => {
                console.error('请求错误:', error);
                streamingDiv.innerHTML = `<span style="color: red;">网络错误: ${error.message}</span>`;
                resetSendButton();
            });
        }
        
        function addMessage(type, content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = content;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function createStreamingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.innerHTML = '<span class="stream-cursor">|</span>';
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageDiv;
        }
        
        function updateStreamingContent(streamingDiv, content) {
            streamingDiv.innerHTML = content + '<span class="stream-cursor">|</span>';
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function finishStreaming(streamingDiv) {
            // 移除光标
            const cursor = streamingDiv.querySelector('.stream-cursor');
            if (cursor) {
                cursor.remove();
            }
        }
        
        function resetSendButton() {
            isProcessing = false;
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = false;
            sendButton.textContent = '发送';
        }
        
        // 回车发送
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
