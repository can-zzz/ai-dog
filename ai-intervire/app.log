[INFO] Scanning for projects...
[INFO] 
[INFO] ------------------------< com.can:ai-assistant >------------------------
[INFO] Building ai-assistant 0.0.1-SNAPSHOT
[INFO]   from pom.xml
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] >>> spring-boot:3.2.3:run (default-cli) > test-compile @ ai-assistant >>>
[INFO] 
[INFO] --- resources:3.3.1:resources (default-resources) @ ai-assistant ---
[INFO] Copying 1 resource from src/main/resources to target/classes
[INFO] Copying 3 resources from src/main/resources to target/classes
[INFO] 
[INFO] --- compiler:3.11.0:compile (default-compile) @ ai-assistant ---
[INFO] Nothing to compile - all classes are up to date
[INFO] 
[INFO] --- resources:3.3.1:testResources (default-testResources) @ ai-assistant ---
[INFO] skip non existing resourceDirectory /Users/can/Documents/ai/ai-intervire/src/test/resources
[INFO] 
[INFO] --- compiler:3.11.0:testCompile (default-testCompile) @ ai-assistant ---
[INFO] No sources to compile
[INFO] 
[INFO] <<< spring-boot:3.2.3:run (default-cli) < test-compile @ ai-assistant <<<
[INFO] 
[INFO] 
[INFO] --- spring-boot:3.2.3:run (default-cli) @ ai-assistant ---
[INFO] Attaching agents: []

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
[32m :: Spring Boot :: [39m              [2m (v3.2.3)[0;39m

15:14:09.330 [main] INFO  c.c.a.AiAssistantApplication - Starting AiAssistantApplication using Java 23.0.2 with PID 93202 (/Users/can/Documents/ai/ai-intervire/target/classes started by can in /Users/can/Documents/ai/ai-intervire)
15:14:09.331 [main] INFO  c.c.a.AiAssistantApplication - No active profile set, falling back to 1 default profile: "default"
15:14:09.713 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat initialized with port 8081 (http)
15:14:09.720 [main] INFO  o.a.catalina.core.StandardService - Starting service [Tomcat]
15:14:09.720 [main] INFO  o.a.catalina.core.StandardEngine - Starting Servlet engine: [Apache Tomcat/10.1.19]
15:14:09.745 [main] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring embedded WebApplicationContext
15:14:09.746 [main] INFO  o.s.b.w.s.c.ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 395 ms
15:14:09.895 [main] INFO  o.s.b.a.w.s.WelcomePageHandlerMapping - Adding welcome page template: index
15:14:09.989 [main] INFO  o.s.b.w.e.tomcat.TomcatWebServer - Tomcat started on port 8081 (http) with context path ''
15:14:09.992 [main] INFO  c.c.a.AiAssistantApplication - Started AiAssistantApplication in 0.824 seconds (process running for 0.964)
15:14:09.993 [main] INFO  c.c.a.AiAssistantApplication - ===========================================
15:14:09.993 [main] INFO  c.c.a.AiAssistantApplication - AI智能助手启动成功！
15:14:09.993 [main] INFO  c.c.a.AiAssistantApplication - 访问地址: http://localhost:8081
15:14:09.993 [main] INFO  c.c.a.AiAssistantApplication - 健康检查: http://localhost:8081/api/ai/health
15:14:09.993 [main] INFO  c.c.a.AiAssistantApplication - ===========================================
15:14:29.160 [http-nio-8081-exec-1] INFO  o.a.c.c.C.[Tomcat].[localhost].[/] - Initializing Spring DispatcherServlet 'dispatcherServlet'
15:14:29.160 [http-nio-8081-exec-1] INFO  o.s.web.servlet.DispatcherServlet - Initializing Servlet 'dispatcherServlet'
15:14:29.161 [http-nio-8081-exec-1] INFO  o.s.web.servlet.DispatcherServlet - Completed initialization in 1 ms
15:14:37.134 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - === 流式聊天请求开始 ===
15:14:37.134 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - 会话ID: prompt-test-basic
15:14:37.135 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - 用户消息: 你好，请介绍一下你自己
15:14:37.135 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - 深度思考: false
15:14:37.135 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - 超时配置: 300000ms
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 🤖 智能体执行开始
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 📋 执行预处理阶段
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.RequestPreprocessor - 🔄 开始预处理请求
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.RequestPreprocessor - ✅ 请求预处理完成 - 会话: prompt-test-basic, 路由: 简单对话, 耗时: 0ms
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 预处理完成 - 路由: 简单对话, 耗时: 0ms
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 🧠 执行内存加载阶段 - 会话: prompt-test-basic
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.MemoryManager - 🧠 加载上下文 - 会话: prompt-test-basic
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.MemoryManager - ✅ 上下文加载完成 - 会话: prompt-test-basic, 历史记录: 0, 压缩后: 0, 耗时: 0ms
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 内存加载完成 - 耗时: 0ms
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 📝 执行响应生成阶段 - 会话: prompt-test-basic
15:14:37.137 [pool-2-thread-1] INFO  c.c.a.service.ResponseGenerator - 📝 响应生成开始 - 会话: prompt-test-basic, 路由: 简单对话
15:14:37.138 [pool-2-thread-1] INFO  c.c.a.service.ResponseGenerator - 🎯 生成策略: 简单生成 - 会话: prompt-test-basic
15:14:37.138 [pool-2-thread-1] INFO  c.c.a.service.ResponseGenerator - 💬 执行简单生成
15:14:37.138 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证流式调用参数 - 会话: unknown
15:14:37.138 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 📡 开始流式AI模型调用 - 会话: unknown, 模型: qwen-turbo, 消息数: 2
15:14:37.657 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 🌐 HTTP响应已接收 - 会话: unknown, 响应时间: 511ms, 状态码: 200
15:14:37.657 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - ⚡ 首个数据块已接收 - 会话: unknown, 首块延迟: 511ms
15:14:38.210 [pool-2-thread-1] ERROR c.c.a.controller.StreamController - Error sending stream response: java.io.IOException: Broken pipe
15:14:38.210 [http-nio-8081-exec-3] ERROR c.c.a.controller.StreamController - ❌ 流式聊天发生错误 - 会话: prompt-test-basic, 错误: Broken pipe, 处理时长: 1076ms
15:14:38.217 [http-nio-8081-exec-3] ERROR c.c.a.e.GlobalExceptionHandler - Unexpected exception occurred: Broken pipe
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at org.springframework.util.StreamUtils.copy(StreamUtils.java:135)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:128)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:44)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.ResponseGenerator$5.onResponse(ResponseGenerator.java:252)
	at com.can.aiassistant.service.AiService.lambda$streamCallAiModel$1(AiService.java:528)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallAiModel(AiService.java:473)
	at com.can.aiassistant.service.ResponseGenerator.executeSimpleGeneration(ResponseGenerator.java:246)
	at com.can.aiassistant.service.ResponseGenerator.executeGenerationStrategy(ResponseGenerator.java:124)
	at com.can.aiassistant.service.ResponseGenerator.generateResponse(ResponseGenerator.java:60)
	at com.can.aiassistant.service.AgentExecutor.executeResponseGeneration(AgentExecutor.java:173)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:72)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:14:38.219 [http-nio-8081-exec-3] WARN  o.s.w.s.m.m.a.ExceptionHandlerExceptionResolver - Failure in @ExceptionHandler com.can.aiassistant.exception.GlobalExceptionHandler#handleGenericException(Exception)
org.springframework.http.converter.HttpMessageNotWritableException: No converter for [class java.util.HashMap] with preset Content-Type 'text/event-stream'
	at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:319)
	at org.springframework.web.servlet.mvc.method.annotation.HttpEntityMethodProcessor.handleReturnValue(HttpEntityMethodProcessor.java:245)
	at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:78)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:136)
	at org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver.doResolveHandlerMethodException(ExceptionHandlerExceptionResolver.java:432)
	at org.springframework.web.servlet.handler.AbstractHandlerMethodExceptionResolver.doResolveException(AbstractHandlerMethodExceptionResolver.java:74)
	at org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver.resolveException(AbstractHandlerExceptionResolver.java:175)
	at org.springframework.web.servlet.handler.HandlerExceptionResolverComposite.resolveException(HandlerExceptionResolverComposite.java:80)
	at org.springframework.web.servlet.DispatcherServlet.processHandlerException(DispatcherServlet.java:1357)
	at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1160)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1106)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:914)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:590)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:205)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:642)
	at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:520)
	at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:463)
	at org.apache.catalina.core.StandardHostValve.custom(StandardHostValve.java:343)
	at org.apache.catalina.core.StandardHostValve.status(StandardHostValve.java:222)
	at org.apache.catalina.core.StandardHostValve.throwable(StandardHostValve.java:308)
	at org.apache.catalina.core.AsyncContextImpl.setErrorState(AsyncContextImpl.java:430)
	at org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:155)
	at org.apache.coyote.AbstractProcessor.dispatch(AbstractProcessor.java:243)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:57)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:896)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1744)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:14:38.220 [http-nio-8081-exec-3] ERROR o.a.c.c.C.[.[.[.[dispatcherServlet] - Servlet.service() for servlet [dispatcherServlet] threw exception
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at org.springframework.util.StreamUtils.copy(StreamUtils.java:135)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:128)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:44)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.ResponseGenerator$5.onResponse(ResponseGenerator.java:252)
	at com.can.aiassistant.service.AiService.lambda$streamCallAiModel$1(AiService.java:528)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallAiModel(AiService.java:473)
	at com.can.aiassistant.service.ResponseGenerator.executeSimpleGeneration(ResponseGenerator.java:246)
	at com.can.aiassistant.service.ResponseGenerator.executeGenerationStrategy(ResponseGenerator.java:124)
	at com.can.aiassistant.service.ResponseGenerator.generateResponse(ResponseGenerator.java:60)
	at com.can.aiassistant.service.AgentExecutor.executeResponseGeneration(AgentExecutor.java:173)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:72)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:14:38.220 [http-nio-8081-exec-3] ERROR o.a.c.c.C.[Tomcat].[localhost] - Exception Processing [ErrorPage[errorCode=0, location=/error]]
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at org.springframework.util.StreamUtils.copy(StreamUtils.java:135)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:128)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:44)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.ResponseGenerator$5.onResponse(ResponseGenerator.java:252)
	at com.can.aiassistant.service.AiService.lambda$streamCallAiModel$1(AiService.java:528)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallAiModel(AiService.java:473)
	at com.can.aiassistant.service.ResponseGenerator.executeSimpleGeneration(ResponseGenerator.java:246)
	at com.can.aiassistant.service.ResponseGenerator.executeGenerationStrategy(ResponseGenerator.java:124)
	at com.can.aiassistant.service.ResponseGenerator.generateResponse(ResponseGenerator.java:60)
	at com.can.aiassistant.service.AgentExecutor.executeResponseGeneration(AgentExecutor.java:173)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:72)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:14:38.221 [http-nio-8081-exec-3] INFO  c.c.a.controller.StreamController - ✅ 流式聊天完成 - 会话: prompt-test-basic, 总处理时长: 1087ms
15:14:38.221 [http-nio-8081-exec-3] INFO  c.c.a.controller.StreamController - === 流式聊天请求结束 ===
15:14:38.319 [pool-2-thread-1] INFO  c.c.a.service.ResponseGenerator - ✅ 响应生成完成 - 会话: prompt-test-basic, 策略: 简单生成, 响应长度: 21, 耗时: 1182ms
15:14:38.320 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 响应生成完成 - 耗时: 1183ms
15:14:38.320 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 💾 执行内存保存阶段 - 会话: prompt-test-basic
15:14:38.320 [pool-2-thread-1] INFO  c.c.a.service.MemoryManager - 💾 保存上下文 - 会话: prompt-test-basic
15:14:38.320 [pool-2-thread-1] INFO  c.c.a.service.MemoryManager - ✅ 上下文保存完成 - 会话: prompt-test-basic, 耗时: 0ms
15:14:38.321 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 内存保存完成 - 耗时: 1ms
15:14:38.321 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 🔄 执行后处理阶段 - 会话: prompt-test-basic
15:14:38.321 [pool-2-thread-1] INFO  c.c.a.service.PostProcessor - 🔄 后处理开始 - 会话: prompt-test-basic
15:14:38.321 [pool-2-thread-1] ERROR c.c.a.service.PostProcessor - ❌ 后处理失败 - 会话: prompt-test-basic, 错误: ResponseBodyEmitter has already completed, 耗时: 0ms
15:14:38.321 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 后处理完成 - 耗时: 0ms
15:14:38.321 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 🎉 智能体执行完成 - 会话: prompt-test-basic, 总耗时: 1184ms
15:14:45.219 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - === 流式聊天请求开始 ===
15:14:45.219 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - 会话ID: prompt-test-thinking
15:14:45.219 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - 用户消息: 如何学习编程
15:14:45.219 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - 深度思考: true
15:14:45.219 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - 超时配置: 300000ms
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 🤖 智能体执行开始
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 📋 执行预处理阶段
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.RequestPreprocessor - 🔄 开始预处理请求
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.RequestPreprocessor - ✅ 请求预处理完成 - 会话: prompt-test-thinking, 路由: 复杂深度思考+工具, 耗时: 0ms
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 预处理完成 - 路由: 复杂深度思考+工具, 耗时: 0ms
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 🧠 执行内存加载阶段 - 会话: prompt-test-thinking
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.MemoryManager - 🧠 加载上下文 - 会话: prompt-test-thinking
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.MemoryManager - ✅ 上下文加载完成 - 会话: prompt-test-thinking, 历史记录: 0, 压缩后: 0, 耗时: 0ms
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 内存加载完成 - 耗时: 0ms
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 🤔 执行思考阶段 - 会话: prompt-test-thinking
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.ThinkingExecutor - 🧠 思考执行器开始 - 会话: prompt-test-thinking
15:14:45.220 [pool-2-thread-1] INFO  c.c.a.service.ThinkingExecutor - 🎯 思考策略: 问题解决 - 会话: prompt-test-thinking
15:14:45.223 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 🧠 开始构建深度思考消息 - 会话: prompt-test-thinking
15:14:45.223 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 🤖 开始调用思考模型 - 会话: prompt-test-thinking, 模型: qwen-max
15:14:45.223 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证思考模型调用参数 - 会话: prompt-test-thinking, 模型: qwen-max
15:14:45.223 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 📡 开始流式思考模型调用 - 会话: prompt-test-thinking, 模型: qwen-max, 消息数: 2
15:14:45.527 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 🌐 思考模型HTTP响应已接收 - 会话: prompt-test-thinking, 响应时间: 303ms, 状态码: 200
15:14:45.527 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - ⚡ 思考模型首个数据块已接收 - 会话: prompt-test-thinking, 首块延迟: 303ms
15:14:48.057 [pool-2-thread-1] ERROR c.c.a.controller.StreamController - Error sending stream response: java.io.IOException: Broken pipe
15:14:48.057 [http-nio-8081-exec-5] ERROR c.c.a.controller.StreamController - ❌ 流式聊天发生错误 - 会话: prompt-test-thinking, 错误: Broken pipe, 处理时长: 2838ms
15:14:48.058 [http-nio-8081-exec-5] ERROR c.c.a.e.GlobalExceptionHandler - Unexpected exception occurred: Broken pipe
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at org.springframework.util.StreamUtils.copy(StreamUtils.java:135)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:128)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:44)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.AiService.lambda$streamCallThinkingModel$0(AiService.java:303)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallThinkingModel(AiService.java:243)
	at com.can.aiassistant.service.AiService.streamThinkingSteps(AiService.java:171)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinkingWithStrategy(ThinkingExecutor.java:191)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinking(ThinkingExecutor.java:72)
	at com.can.aiassistant.service.AgentExecutor.executeThinking(AgentExecutor.java:146)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:63)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:14:48.059 [http-nio-8081-exec-5] WARN  o.s.w.s.m.m.a.ExceptionHandlerExceptionResolver - Failure in @ExceptionHandler com.can.aiassistant.exception.GlobalExceptionHandler#handleGenericException(Exception)
org.springframework.http.converter.HttpMessageNotWritableException: No converter for [class java.util.HashMap] with preset Content-Type 'text/event-stream'
	at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:319)
	at org.springframework.web.servlet.mvc.method.annotation.HttpEntityMethodProcessor.handleReturnValue(HttpEntityMethodProcessor.java:245)
	at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:78)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:136)
	at org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver.doResolveHandlerMethodException(ExceptionHandlerExceptionResolver.java:432)
	at org.springframework.web.servlet.handler.AbstractHandlerMethodExceptionResolver.doResolveException(AbstractHandlerMethodExceptionResolver.java:74)
	at org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver.resolveException(AbstractHandlerExceptionResolver.java:175)
	at org.springframework.web.servlet.handler.HandlerExceptionResolverComposite.resolveException(HandlerExceptionResolverComposite.java:80)
	at org.springframework.web.servlet.DispatcherServlet.processHandlerException(DispatcherServlet.java:1357)
	at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1160)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1106)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:914)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:590)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:205)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:642)
	at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:520)
	at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:463)
	at org.apache.catalina.core.StandardHostValve.custom(StandardHostValve.java:343)
	at org.apache.catalina.core.StandardHostValve.status(StandardHostValve.java:222)
	at org.apache.catalina.core.StandardHostValve.throwable(StandardHostValve.java:308)
	at org.apache.catalina.core.AsyncContextImpl.setErrorState(AsyncContextImpl.java:430)
	at org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:155)
	at org.apache.coyote.AbstractProcessor.dispatch(AbstractProcessor.java:243)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:57)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:896)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1744)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:14:48.060 [http-nio-8081-exec-5] ERROR o.a.c.c.C.[.[.[.[dispatcherServlet] - Servlet.service() for servlet [dispatcherServlet] threw exception
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at org.springframework.util.StreamUtils.copy(StreamUtils.java:135)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:128)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:44)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.AiService.lambda$streamCallThinkingModel$0(AiService.java:303)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallThinkingModel(AiService.java:243)
	at com.can.aiassistant.service.AiService.streamThinkingSteps(AiService.java:171)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinkingWithStrategy(ThinkingExecutor.java:191)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinking(ThinkingExecutor.java:72)
	at com.can.aiassistant.service.AgentExecutor.executeThinking(AgentExecutor.java:146)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:63)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:14:48.061 [http-nio-8081-exec-5] ERROR o.a.c.c.C.[Tomcat].[localhost] - Exception Processing [ErrorPage[errorCode=0, location=/error]]
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at org.springframework.util.StreamUtils.copy(StreamUtils.java:135)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:128)
	at org.springframework.http.converter.StringHttpMessageConverter.writeInternal(StringHttpMessageConverter.java:44)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.AiService.lambda$streamCallThinkingModel$0(AiService.java:303)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallThinkingModel(AiService.java:243)
	at com.can.aiassistant.service.AiService.streamThinkingSteps(AiService.java:171)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinkingWithStrategy(ThinkingExecutor.java:191)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinking(ThinkingExecutor.java:72)
	at com.can.aiassistant.service.AgentExecutor.executeThinking(AgentExecutor.java:146)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:63)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:14:48.061 [http-nio-8081-exec-5] INFO  c.c.a.controller.StreamController - ✅ 流式聊天完成 - 会话: prompt-test-thinking, 总处理时长: 2842ms
15:14:48.061 [http-nio-8081-exec-5] INFO  c.c.a.controller.StreamController - === 流式聊天请求结束 ===
15:15:18.422 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - 🤖 流式思考模型调用完成 - 会话: prompt-test-thinking, 耗时: 33199ms
15:15:18.423 [pool-2-thread-1] INFO  c.can.aiassistant.service.AiService - ✅ 思考步骤流式输出完成 - 会话: prompt-test-thinking, 总耗时: 33200ms
15:15:18.424 [pool-2-thread-1] INFO  c.c.a.service.ThinkingExecutor - ✅ 思考执行完成 - 会话: prompt-test-thinking, 策略: 问题解决, 耗时: 33204ms
15:15:18.424 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 思考阶段完成 - 耗时: 33204ms
15:15:18.424 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 🔧 执行函数调用阶段 - 会话: prompt-test-thinking
15:15:18.424 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - ✅ 函数调用完成 - 耗时: 0ms
15:15:18.424 [pool-2-thread-1] INFO  c.c.a.service.AgentExecutor - 📝 执行响应生成阶段 - 会话: prompt-test-thinking
15:15:18.424 [pool-2-thread-1] INFO  c.c.a.service.ResponseGenerator - 📝 响应生成开始 - 会话: prompt-test-thinking, 路由: 复杂深度思考+工具
15:15:18.424 [pool-2-thread-1] INFO  c.c.a.service.ResponseGenerator - 🎯 生成策略: 基于思考生成 - 会话: prompt-test-thinking
15:15:18.424 [pool-2-thread-1] INFO  c.c.a.service.ResponseGenerator - 🤔 执行基于思考的生成
15:15:18.424 [pool-2-thread-1] ERROR c.c.a.service.ResponseGenerator - ❌ 响应生成失败 - 会话: prompt-test-thinking, 错误: ResponseBodyEmitter has already completed, 耗时: 0ms
15:15:18.425 [pool-2-thread-1] ERROR c.c.a.service.AgentExecutor - ❌ 智能体执行失败 - 错误: ResponseBodyEmitter has already completed, 耗时: 33205ms
15:15:18.425 [pool-2-thread-1] ERROR c.c.a.controller.StreamController - Stream chat error: ResponseBodyEmitter has already completed
Exception in thread "pool-2-thread-1" java.lang.IllegalStateException: ResponseBodyEmitter has already completed
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:223)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:99)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:17:52.031 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - === 流式聊天请求开始 ===
15:17:52.032 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - 会话ID: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:17:52.032 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - 用户消息: trcvgbhjn
15:17:52.032 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - 深度思考: true
15:17:52.032 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - 超时配置: 300000ms
15:17:52.032 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🤖 智能体执行开始
15:17:52.032 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 📋 执行预处理阶段
15:17:52.032 [pool-2-thread-3] INFO  c.c.a.service.RequestPreprocessor - 🔄 开始预处理请求
15:17:52.033 [pool-2-thread-3] INFO  c.c.a.service.RequestPreprocessor - ✅ 请求预处理完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 路由: 简单深度思考, 耗时: 1ms
15:17:52.033 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 预处理完成 - 路由: 简单深度思考, 耗时: 1ms
15:17:52.033 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🧠 执行内存加载阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:17:52.033 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - 🧠 加载上下文 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:17:52.033 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - ✅ 上下文加载完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 历史记录: 0, 压缩后: 0, 耗时: 0ms
15:17:52.033 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 内存加载完成 - 耗时: 0ms
15:17:52.033 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🤔 执行思考阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:17:52.033 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - 🧠 思考执行器开始 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:17:52.034 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - 🎯 思考策略: 通用思考 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:17:52.035 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🧠 开始构建深度思考消息 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:17:52.035 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🤖 开始调用思考模型 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 模型: qwen-max
15:17:52.036 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证思考模型调用参数 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 模型: qwen-max
15:17:52.036 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 📡 开始流式思考模型调用 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 模型: qwen-max, 消息数: 2
15:17:52.512 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🌐 思考模型HTTP响应已接收 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 响应时间: 476ms, 状态码: 200
15:17:52.512 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ⚡ 思考模型首个数据块已接收 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 首块延迟: 476ms
15:18:22.671 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🏁 思考模型流式响应结束 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总块数: 109
15:18:22.671 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ✅ 思考模型流式响应处理完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总耗时: 30635ms, 总块数: 109, 首块延迟: 476ms, 思考内容长度: 886字符
15:18:22.672 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🤖 流式思考模型调用完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 耗时: 30636ms
15:18:22.672 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ✅ 思考步骤流式输出完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总耗时: 30637ms
15:18:22.672 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - ✅ 思考执行完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 策略: 通用思考, 耗时: 30639ms
15:18:22.672 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 思考阶段完成 - 耗时: 30639ms
15:18:22.672 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 📝 执行响应生成阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:22.672 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 📝 响应生成开始 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 路由: 简单深度思考
15:18:22.672 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 🎯 生成策略: 基于思考生成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:22.672 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 🤔 执行基于思考的生成
15:18:22.673 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证流式调用参数 - 会话: unknown
15:18:22.674 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 📡 开始流式AI模型调用 - 会话: unknown, 模型: qwen-turbo, 消息数: 3
15:18:22.885 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🌐 HTTP响应已接收 - 会话: unknown, 响应时间: 211ms, 状态码: 200
15:18:22.885 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ⚡ 首个数据块已接收 - 会话: unknown, 首块延迟: 211ms
15:18:24.295 [pool-2-thread-3] WARN  c.can.aiassistant.service.AiService - Could not find sessionId for message history
15:18:24.397 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🏁 流式响应结束标记 - 会话: unknown, 总块数: 15
15:18:24.398 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ✅ 流式响应处理完成 - 会话: unknown, 总耗时: 1725ms, 总块数: 15, 首块延迟: 211ms, 消息长度: 59字符
15:18:24.398 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - ✅ 响应生成完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 策略: 基于思考生成, 响应长度: 59, 耗时: 1726ms
15:18:24.398 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 响应生成完成 - 耗时: 1726ms
15:18:24.398 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 💾 执行内存保存阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:24.398 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - 💾 保存上下文 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:24.398 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - ✅ 上下文保存完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 耗时: 0ms
15:18:24.398 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 内存保存完成 - 耗时: 0ms
15:18:24.399 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🔄 执行后处理阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:24.399 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 🔄 后处理开始 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:24.401 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📋 === 详细分析报告 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a ===
15:18:24.401 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 🎯 处理路由: 简单深度思考
15:18:24.401 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📊 质量评估: 总分={:.2f}, 完整性={:.2f}, 相关性={:.2f}, 清晰度={:.2f}, 效率={:.2f}
15:18:24.401 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - ⏱️ 性能统计: 预处理=1ms, 总处理=0ms
15:18:24.401 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 💰 资源消耗: Tokens=0, 成本=0
15:18:24.401 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📋 === 分析报告结束 ===
15:18:24.402 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - ✅ 后处理完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 质量评分: {:.2f}, 耗时: 0.97ms
15:18:24.402 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 后处理完成 - 耗时: 3ms
15:18:24.402 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🎉 智能体执行完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总耗时: 32370ms
15:18:24.402 [http-nio-8081-exec-8] INFO  c.c.a.controller.StreamController - ✅ 流式聊天完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总处理时长: 32371ms
15:18:24.402 [http-nio-8081-exec-8] INFO  c.c.a.controller.StreamController - === 流式聊天请求结束 ===
15:18:38.721 [http-nio-8081-exec-9] INFO  c.c.a.controller.StreamController - === 流式聊天请求开始 ===
15:18:38.721 [http-nio-8081-exec-9] INFO  c.c.a.controller.StreamController - 会话ID: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:38.721 [http-nio-8081-exec-9] INFO  c.c.a.controller.StreamController - 用户消息: 给我生成一个幽默故事
15:18:38.721 [http-nio-8081-exec-9] INFO  c.c.a.controller.StreamController - 深度思考: true
15:18:38.721 [http-nio-8081-exec-9] INFO  c.c.a.controller.StreamController - 超时配置: 300000ms
15:18:38.721 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🤖 智能体执行开始
15:18:38.721 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 📋 执行预处理阶段
15:18:38.721 [pool-2-thread-3] INFO  c.c.a.service.RequestPreprocessor - 🔄 开始预处理请求
15:18:38.721 [pool-2-thread-3] INFO  c.c.a.service.RequestPreprocessor - ✅ 请求预处理完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 路由: 简单深度思考, 耗时: 0ms
15:18:38.721 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 预处理完成 - 路由: 简单深度思考, 耗时: 0ms
15:18:38.721 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🧠 执行内存加载阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:38.722 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - 🧠 加载上下文 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:38.725 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - ✅ 上下文加载完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 历史记录: 2, 压缩后: 2, 耗时: 3ms
15:18:38.725 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 内存加载完成 - 耗时: 4ms
15:18:38.726 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🤔 执行思考阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:38.726 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - 🧠 思考执行器开始 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:38.726 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - 🎯 思考策略: 通用思考 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:38.726 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🧠 开始构建深度思考消息 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:18:38.727 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🤖 开始调用思考模型 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 模型: qwen-max
15:18:38.727 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证思考模型调用参数 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 模型: qwen-max
15:18:38.727 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 📡 开始流式思考模型调用 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 模型: qwen-max, 消息数: 2
15:18:39.230 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🌐 思考模型HTTP响应已接收 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 响应时间: 503ms, 状态码: 200
15:18:39.230 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ⚡ 思考模型首个数据块已接收 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 首块延迟: 503ms
15:19:30.253 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🏁 思考模型流式响应结束 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总块数: 136
15:19:30.254 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ✅ 思考模型流式响应处理完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总耗时: 51527ms, 总块数: 136, 首块延迟: 503ms, 思考内容长度: 1029字符
15:19:30.254 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🤖 流式思考模型调用完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 耗时: 51527ms
15:19:30.255 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ✅ 思考步骤流式输出完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总耗时: 51529ms
15:19:30.255 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - ✅ 思考执行完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 策略: 通用思考, 耗时: 51529ms
15:19:30.255 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 思考阶段完成 - 耗时: 51529ms
15:19:30.255 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 📝 执行响应生成阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:19:30.255 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 📝 响应生成开始 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 路由: 简单深度思考
15:19:30.255 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 🎯 生成策略: 基于思考生成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:19:30.255 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 🤔 执行基于思考的生成
15:19:30.256 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证流式调用参数 - 会话: unknown
15:19:30.256 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 📡 开始流式AI模型调用 - 会话: unknown, 模型: qwen-turbo, 消息数: 3
15:19:30.447 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🌐 HTTP响应已接收 - 会话: unknown, 响应时间: 191ms, 状态码: 200
15:19:30.447 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ⚡ 首个数据块已接收 - 会话: unknown, 首块延迟: 191ms
15:19:37.817 [pool-2-thread-3] WARN  c.can.aiassistant.service.AiService - Could not find sessionId for message history
15:19:37.928 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🏁 流式响应结束标记 - 会话: unknown, 总块数: 70
15:19:37.928 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ✅ 流式响应处理完成 - 会话: unknown, 总耗时: 7672ms, 总块数: 70, 首块延迟: 191ms, 消息长度: 408字符
15:19:37.929 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - ✅ 响应生成完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 策略: 基于思考生成, 响应长度: 408, 耗时: 7674ms
15:19:37.929 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 响应生成完成 - 耗时: 7674ms
15:19:37.929 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 💾 执行内存保存阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:19:37.929 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - 💾 保存上下文 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:19:37.929 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - ✅ 上下文保存完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 耗时: 0ms
15:19:37.929 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 内存保存完成 - 耗时: 0ms
15:19:37.929 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🔄 执行后处理阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:19:37.929 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 🔄 后处理开始 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:19:37.936 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📋 === 详细分析报告 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a ===
15:19:37.937 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 🎯 处理路由: 简单深度思考
15:19:37.937 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📊 质量评估: 总分={:.2f}, 完整性={:.2f}, 相关性={:.2f}, 清晰度={:.2f}, 效率={:.2f}
15:19:37.937 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - ⏱️ 性能统计: 预处理=0ms, 总处理=3ms
15:19:37.937 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 💰 资源消耗: Tokens=0, 成本=0
15:19:37.937 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📋 === 分析报告结束 ===
15:19:37.937 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - ✅ 后处理完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 质量评分: {:.2f}, 耗时: 1.0ms
15:19:37.937 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 后处理完成 - 耗时: 8ms
15:19:37.937 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🎉 智能体执行完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总耗时: 59216ms
15:19:37.938 [http-nio-8081-exec-1] INFO  c.c.a.controller.StreamController - ✅ 流式聊天完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总处理时长: 59218ms
15:19:37.938 [http-nio-8081-exec-1] INFO  c.c.a.controller.StreamController - === 流式聊天请求结束 ===
15:19:44.253 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - === 流式聊天请求开始 ===
15:19:44.253 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - 会话ID: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:44.253 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - 用户消息: 给我生产一个笑话
15:19:44.253 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - 深度思考: false
15:19:44.253 [http-nio-8081-exec-2] INFO  c.c.a.controller.StreamController - 超时配置: 300000ms
15:19:44.253 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🤖 智能体执行开始
15:19:44.253 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 📋 执行预处理阶段
15:19:44.253 [pool-2-thread-3] INFO  c.c.a.service.RequestPreprocessor - 🔄 开始预处理请求
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.RequestPreprocessor - ✅ 请求预处理完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 路由: 标准对话, 耗时: 1ms
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 预处理完成 - 路由: 标准对话, 耗时: 1ms
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🧠 执行内存加载阶段 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - 🧠 加载上下文 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - ✅ 上下文加载完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 历史记录: 0, 压缩后: 0, 耗时: 0ms
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 内存加载完成 - 耗时: 0ms
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 📝 执行响应生成阶段 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 📝 响应生成开始 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 路由: 标准对话
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 🎯 生成策略: 上下文感知生成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:44.254 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 🧠 执行上下文感知生成
15:19:44.255 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证流式调用参数 - 会话: unknown
15:19:44.255 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 📡 开始流式AI模型调用 - 会话: unknown, 模型: qwen-turbo, 消息数: 2
15:19:44.479 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🌐 HTTP响应已接收 - 会话: unknown, 响应时间: 224ms, 状态码: 200
15:19:44.479 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ⚡ 首个数据块已接收 - 会话: unknown, 首块延迟: 224ms
15:19:47.305 [pool-2-thread-3] WARN  c.can.aiassistant.service.AiService - Could not find sessionId for message history
15:19:47.408 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🏁 流式响应结束标记 - 会话: unknown, 总块数: 28
15:19:47.408 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ✅ 流式响应处理完成 - 会话: unknown, 总耗时: 3154ms, 总块数: 28, 首块延迟: 224ms, 消息长度: 137字符
15:19:47.408 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - ✅ 响应生成完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 策略: 上下文感知生成, 响应长度: 137, 耗时: 3154ms
15:19:47.408 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 响应生成完成 - 耗时: 3154ms
15:19:47.408 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 💾 执行内存保存阶段 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:47.408 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - 💾 保存上下文 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:47.409 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - ✅ 上下文保存完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 耗时: 1ms
15:19:47.409 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 内存保存完成 - 耗时: 1ms
15:19:47.409 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🔄 执行后处理阶段 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:47.409 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 🔄 后处理开始 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📋 === 详细分析报告 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1 ===
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 🎯 处理路由: 标准对话
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📊 质量评估: 总分={:.2f}, 完整性={:.2f}, 相关性={:.2f}, 清晰度={:.2f}, 效率={:.2f}
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - ⏱️ 性能统计: 预处理=1ms, 总处理=0ms
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 💰 资源消耗: Tokens=0, 成本=0
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - 📋 === 分析报告结束 ===
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.PostProcessor - ✅ 后处理完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 质量评分: {:.2f}, 耗时: 0.97ms
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 后处理完成 - 耗时: 1ms
15:19:47.410 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🎉 智能体执行完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 总耗时: 3157ms
15:19:47.411 [http-nio-8081-exec-3] INFO  c.c.a.controller.StreamController - ✅ 流式聊天完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 总处理时长: 3158ms
15:19:47.411 [http-nio-8081-exec-3] INFO  c.c.a.controller.StreamController - === 流式聊天请求结束 ===
15:19:52.898 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - === 流式聊天请求开始 ===
15:19:52.898 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - 会话ID: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:52.898 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - 用户消息: rweqr
15:19:52.898 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - 深度思考: true
15:19:52.898 [http-nio-8081-exec-4] INFO  c.c.a.controller.StreamController - 超时配置: 300000ms
15:19:52.898 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🤖 智能体执行开始
15:19:52.898 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 📋 执行预处理阶段
15:19:52.898 [pool-2-thread-3] INFO  c.c.a.service.RequestPreprocessor - 🔄 开始预处理请求
15:19:52.898 [pool-2-thread-3] INFO  c.c.a.service.RequestPreprocessor - ✅ 请求预处理完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 路由: 简单深度思考, 耗时: 0ms
15:19:52.898 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 预处理完成 - 路由: 简单深度思考, 耗时: 0ms
15:19:52.898 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🧠 执行内存加载阶段 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:52.898 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - 🧠 加载上下文 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:52.899 [pool-2-thread-3] INFO  c.c.a.service.MemoryManager - ✅ 上下文加载完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 历史记录: 2, 压缩后: 2, 耗时: 1ms
15:19:52.899 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 内存加载完成 - 耗时: 1ms
15:19:52.899 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 🤔 执行思考阶段 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:52.899 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - 🧠 思考执行器开始 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:52.899 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - 🎯 思考策略: 通用思考 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:52.900 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🧠 开始构建深度思考消息 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:19:52.900 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🤖 开始调用思考模型 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 模型: qwen-max
15:19:52.900 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证思考模型调用参数 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 模型: qwen-max
15:19:52.900 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 📡 开始流式思考模型调用 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 模型: qwen-max, 消息数: 2
15:19:53.381 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🌐 思考模型HTTP响应已接收 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 响应时间: 481ms, 状态码: 200
15:19:53.382 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ⚡ 思考模型首个数据块已接收 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 首块延迟: 482ms
15:20:07.377 [pool-2-thread-3] ERROR c.c.a.controller.StreamController - Error sending stream response: java.io.IOException: Broken pipe
15:20:07.377 [http-nio-8081-exec-5] ERROR c.c.a.controller.StreamController - ❌ 流式聊天发生错误 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 错误: Broken pipe, 处理时长: 14479ms
15:20:07.380 [http-nio-8081-exec-5] ERROR c.c.a.e.GlobalExceptionHandler - Unexpected exception occurred: Broken pipe
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at java.base/java.io.FilterOutputStream.flush(FilterOutputStream.java:155)
	at com.fasterxml.jackson.core.json.UTF8JsonGenerator.flush(UTF8JsonGenerator.java:1200)
	at com.fasterxml.jackson.databind.ObjectWriter.writeValue(ObjectWriter.java:1063)
	at org.springframework.http.converter.json.AbstractJackson2HttpMessageConverter.writeInternal(AbstractJackson2HttpMessageConverter.java:483)
	at org.springframework.http.converter.AbstractGenericHttpMessageConverter.writeInternal(AbstractGenericHttpMessageConverter.java:123)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.AiService.lambda$streamCallThinkingModel$0(AiService.java:303)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallThinkingModel(AiService.java:243)
	at com.can.aiassistant.service.AiService.streamThinkingSteps(AiService.java:171)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinkingWithStrategy(ThinkingExecutor.java:191)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinking(ThinkingExecutor.java:72)
	at com.can.aiassistant.service.AgentExecutor.executeThinking(AgentExecutor.java:146)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:63)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:20:07.382 [http-nio-8081-exec-5] WARN  o.s.w.s.m.m.a.ExceptionHandlerExceptionResolver - Failure in @ExceptionHandler com.can.aiassistant.exception.GlobalExceptionHandler#handleGenericException(Exception)
org.springframework.http.converter.HttpMessageNotWritableException: No converter for [class java.util.HashMap] with preset Content-Type 'text/event-stream'
	at org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor.writeWithMessageConverters(AbstractMessageConverterMethodProcessor.java:319)
	at org.springframework.web.servlet.mvc.method.annotation.HttpEntityMethodProcessor.handleReturnValue(HttpEntityMethodProcessor.java:245)
	at org.springframework.web.method.support.HandlerMethodReturnValueHandlerComposite.handleReturnValue(HandlerMethodReturnValueHandlerComposite.java:78)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:136)
	at org.springframework.web.servlet.mvc.method.annotation.ExceptionHandlerExceptionResolver.doResolveHandlerMethodException(ExceptionHandlerExceptionResolver.java:432)
	at org.springframework.web.servlet.handler.AbstractHandlerMethodExceptionResolver.doResolveException(AbstractHandlerMethodExceptionResolver.java:74)
	at org.springframework.web.servlet.handler.AbstractHandlerExceptionResolver.resolveException(AbstractHandlerExceptionResolver.java:175)
	at org.springframework.web.servlet.handler.HandlerExceptionResolverComposite.resolveException(HandlerExceptionResolverComposite.java:80)
	at org.springframework.web.servlet.DispatcherServlet.processHandlerException(DispatcherServlet.java:1357)
	at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1160)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1106)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:914)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:590)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)
	at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:205)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:174)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:149)
	at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:642)
	at org.apache.catalina.core.ApplicationDispatcher.doInclude(ApplicationDispatcher.java:520)
	at org.apache.catalina.core.ApplicationDispatcher.include(ApplicationDispatcher.java:463)
	at org.apache.catalina.core.StandardHostValve.custom(StandardHostValve.java:343)
	at org.apache.catalina.core.StandardHostValve.status(StandardHostValve.java:222)
	at org.apache.catalina.core.StandardHostValve.throwable(StandardHostValve.java:308)
	at org.apache.catalina.core.AsyncContextImpl.setErrorState(AsyncContextImpl.java:430)
	at org.apache.catalina.connector.CoyoteAdapter.asyncDispatch(CoyoteAdapter.java:155)
	at org.apache.coyote.AbstractProcessor.dispatch(AbstractProcessor.java:243)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:57)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:896)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1744)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)
	at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:20:07.384 [http-nio-8081-exec-5] ERROR o.a.c.c.C.[.[.[.[dispatcherServlet] - Servlet.service() for servlet [dispatcherServlet] threw exception
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at java.base/java.io.FilterOutputStream.flush(FilterOutputStream.java:155)
	at com.fasterxml.jackson.core.json.UTF8JsonGenerator.flush(UTF8JsonGenerator.java:1200)
	at com.fasterxml.jackson.databind.ObjectWriter.writeValue(ObjectWriter.java:1063)
	at org.springframework.http.converter.json.AbstractJackson2HttpMessageConverter.writeInternal(AbstractJackson2HttpMessageConverter.java:483)
	at org.springframework.http.converter.AbstractGenericHttpMessageConverter.writeInternal(AbstractGenericHttpMessageConverter.java:123)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.AiService.lambda$streamCallThinkingModel$0(AiService.java:303)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallThinkingModel(AiService.java:243)
	at com.can.aiassistant.service.AiService.streamThinkingSteps(AiService.java:171)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinkingWithStrategy(ThinkingExecutor.java:191)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinking(ThinkingExecutor.java:72)
	at com.can.aiassistant.service.AgentExecutor.executeThinking(AgentExecutor.java:146)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:63)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:20:07.384 [http-nio-8081-exec-5] ERROR o.a.c.c.C.[Tomcat].[localhost] - Exception Processing [ErrorPage[errorCode=0, location=/error]]
java.io.IOException: Broken pipe
	at java.base/sun.nio.ch.SocketDispatcher.write0(Native Method)
	at java.base/sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:62)
	at java.base/sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:137)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:102)
	at java.base/sun.nio.ch.IOUtil.write(IOUtil.java:58)
	at java.base/sun.nio.ch.SocketChannelImpl.implWrite(SocketChannelImpl.java:566)
	at java.base/sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:618)
	at org.apache.tomcat.util.net.NioChannel.write(NioChannel.java:118)
	at org.apache.tomcat.util.net.NioEndpoint$NioSocketWrapper.doWrite(NioEndpoint.java:1381)
	at org.apache.tomcat.util.net.SocketWrapperBase.doWrite(SocketWrapperBase.java:764)
	at org.apache.tomcat.util.net.SocketWrapperBase.flushBlocking(SocketWrapperBase.java:728)
	at org.apache.tomcat.util.net.SocketWrapperBase.flush(SocketWrapperBase.java:712)
	at org.apache.coyote.http11.Http11OutputBuffer$SocketOutputBuffer.flush(Http11OutputBuffer.java:566)
	at org.apache.coyote.http11.filters.ChunkedOutputFilter.flush(ChunkedOutputFilter.java:157)
	at org.apache.coyote.http11.Http11OutputBuffer.flush(Http11OutputBuffer.java:220)
	at org.apache.coyote.http11.Http11Processor.flush(Http11Processor.java:1245)
	at org.apache.coyote.AbstractProcessor.action(AbstractProcessor.java:400)
	at org.apache.coyote.Response.action(Response.java:208)
	at org.apache.catalina.connector.OutputBuffer.doFlush(OutputBuffer.java:301)
	at org.apache.catalina.connector.OutputBuffer.flush(OutputBuffer.java:267)
	at org.apache.catalina.connector.CoyoteOutputStream.flush(CoyoteOutputStream.java:120)
	at java.base/java.io.FilterOutputStream.flush(FilterOutputStream.java:155)
	at com.fasterxml.jackson.core.json.UTF8JsonGenerator.flush(UTF8JsonGenerator.java:1200)
	at com.fasterxml.jackson.databind.ObjectWriter.writeValue(ObjectWriter.java:1063)
	at org.springframework.http.converter.json.AbstractJackson2HttpMessageConverter.writeInternal(AbstractJackson2HttpMessageConverter.java:483)
	at org.springframework.http.converter.AbstractGenericHttpMessageConverter.writeInternal(AbstractGenericHttpMessageConverter.java:123)
	at org.springframework.http.converter.AbstractHttpMessageConverter.write(AbstractHttpMessageConverter.java:236)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.sendInternal(ResponseBodyEmitterReturnValueHandler.java:221)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitterReturnValueHandler$HttpMessageConvertingHandler.send(ResponseBodyEmitterReturnValueHandler.java:212)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.sendInternal(ResponseBodyEmitter.java:234)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:225)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$3(StreamController.java:86)
	at com.can.aiassistant.service.AiService.lambda$streamCallThinkingModel$0(AiService.java:303)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:247)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:188)
	at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:162)
	at com.can.aiassistant.service.AiService.streamCallThinkingModel(AiService.java:243)
	at com.can.aiassistant.service.AiService.streamThinkingSteps(AiService.java:171)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinkingWithStrategy(ThinkingExecutor.java:191)
	at com.can.aiassistant.service.ThinkingExecutor.executeThinking(ThinkingExecutor.java:72)
	at com.can.aiassistant.service.AgentExecutor.executeThinking(AgentExecutor.java:146)
	at com.can.aiassistant.service.AgentExecutor.execute(AgentExecutor.java:63)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:84)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:20:07.385 [http-nio-8081-exec-5] INFO  c.c.a.controller.StreamController - ✅ 流式聊天完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 总处理时长: 14487ms
15:20:07.385 [http-nio-8081-exec-5] INFO  c.c.a.controller.StreamController - === 流式聊天请求结束 ===
15:20:23.299 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - 🤖 流式思考模型调用完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 耗时: 30398ms
15:20:23.304 [pool-2-thread-3] INFO  c.can.aiassistant.service.AiService - ✅ 思考步骤流式输出完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 总耗时: 30404ms
15:20:23.304 [pool-2-thread-3] INFO  c.c.a.service.ThinkingExecutor - ✅ 思考执行完成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 策略: 通用思考, 耗时: 30405ms
15:20:23.304 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - ✅ 思考阶段完成 - 耗时: 30405ms
15:20:23.304 [pool-2-thread-3] INFO  c.c.a.service.AgentExecutor - 📝 执行响应生成阶段 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:20:23.304 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 📝 响应生成开始 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 路由: 简单深度思考
15:20:23.304 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 🎯 生成策略: 基于思考生成 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1
15:20:23.304 [pool-2-thread-3] INFO  c.c.a.service.ResponseGenerator - 🤔 执行基于思考的生成
15:20:23.304 [pool-2-thread-3] ERROR c.c.a.service.ResponseGenerator - ❌ 响应生成失败 - 会话: 2f6d2a3e-891a-4aeb-ac25-75136a9c37b1, 错误: ResponseBodyEmitter has already completed, 耗时: 0ms
15:20:23.304 [pool-2-thread-3] ERROR c.c.a.service.AgentExecutor - ❌ 智能体执行失败 - 错误: ResponseBodyEmitter has already completed, 耗时: 30406ms
15:20:23.304 [pool-2-thread-3] ERROR c.c.a.controller.StreamController - Stream chat error: ResponseBodyEmitter has already completed
Exception in thread "pool-2-thread-3" java.lang.IllegalStateException: ResponseBodyEmitter has already completed
	at org.springframework.util.Assert.state(Assert.java:97)
	at org.springframework.web.servlet.mvc.method.annotation.ResponseBodyEmitter.send(ResponseBodyEmitter.java:223)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:135)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:118)
	at org.springframework.web.servlet.mvc.method.annotation.SseEmitter.send(SseEmitter.java:99)
	at com.can.aiassistant.controller.StreamController.lambda$streamChat$4(StreamController.java:99)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)
	at java.base/java.lang.Thread.run(Thread.java:1575)
15:21:12.127 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - === 流式聊天请求开始 ===
15:21:12.129 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - 会话ID: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:12.129 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - 用户消息: 给我生成一个幽默故事
15:21:12.129 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - 深度思考: false
15:21:12.129 [http-nio-8081-exec-7] INFO  c.c.a.controller.StreamController - 超时配置: 300000ms
15:21:12.129 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - 🤖 智能体执行开始
15:21:12.129 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - 📋 执行预处理阶段
15:21:12.129 [pool-2-thread-4] INFO  c.c.a.service.RequestPreprocessor - 🔄 开始预处理请求
15:21:12.129 [pool-2-thread-4] INFO  c.c.a.service.RequestPreprocessor - ✅ 请求预处理完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 路由: 标准对话, 耗时: 0ms
15:21:12.129 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - ✅ 预处理完成 - 路由: 标准对话, 耗时: 0ms
15:21:12.129 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - 🧠 执行内存加载阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:12.129 [pool-2-thread-4] INFO  c.c.a.service.MemoryManager - 🧠 加载上下文 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:12.130 [pool-2-thread-4] INFO  c.c.a.service.MemoryManager - ✅ 上下文加载完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 历史记录: 4, 压缩后: 4, 耗时: 1ms
15:21:12.130 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - ✅ 内存加载完成 - 耗时: 1ms
15:21:12.130 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - 📝 执行响应生成阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:12.130 [pool-2-thread-4] INFO  c.c.a.service.ResponseGenerator - 📝 响应生成开始 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 路由: 标准对话
15:21:12.130 [pool-2-thread-4] INFO  c.c.a.service.ResponseGenerator - 🎯 生成策略: 上下文感知生成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:12.130 [pool-2-thread-4] INFO  c.c.a.service.ResponseGenerator - 🧠 执行上下文感知生成
15:21:12.130 [pool-2-thread-4] INFO  c.can.aiassistant.service.AiService - 🔍 开始验证流式调用参数 - 会话: unknown
15:21:12.130 [pool-2-thread-4] INFO  c.can.aiassistant.service.AiService - 📡 开始流式AI模型调用 - 会话: unknown, 模型: qwen-turbo, 消息数: 6
15:21:12.544 [pool-2-thread-4] INFO  c.can.aiassistant.service.AiService - 🌐 HTTP响应已接收 - 会话: unknown, 响应时间: 413ms, 状态码: 200
15:21:12.544 [pool-2-thread-4] INFO  c.can.aiassistant.service.AiService - ⚡ 首个数据块已接收 - 会话: unknown, 首块延迟: 413ms
15:21:20.868 [pool-2-thread-4] WARN  c.can.aiassistant.service.AiService - Could not find sessionId for message history
15:21:20.977 [pool-2-thread-4] INFO  c.can.aiassistant.service.AiService - 🏁 流式响应结束标记 - 会话: unknown, 总块数: 79
15:21:20.977 [pool-2-thread-4] INFO  c.can.aiassistant.service.AiService - ✅ 流式响应处理完成 - 会话: unknown, 总耗时: 8847ms, 总块数: 79, 首块延迟: 413ms, 消息长度: 455字符
15:21:20.978 [pool-2-thread-4] INFO  c.c.a.service.ResponseGenerator - ✅ 响应生成完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 策略: 上下文感知生成, 响应长度: 455, 耗时: 8848ms
15:21:20.978 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - ✅ 响应生成完成 - 耗时: 8848ms
15:21:20.978 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - 💾 执行内存保存阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:20.978 [pool-2-thread-4] INFO  c.c.a.service.MemoryManager - 💾 保存上下文 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:20.978 [pool-2-thread-4] INFO  c.c.a.service.MemoryManager - ✅ 上下文保存完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 耗时: 0ms
15:21:20.978 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - ✅ 内存保存完成 - 耗时: 0ms
15:21:20.978 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - 🔄 执行后处理阶段 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:20.978 [pool-2-thread-4] INFO  c.c.a.service.PostProcessor - 🔄 后处理开始 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a
15:21:20.979 [pool-2-thread-4] INFO  c.c.a.service.PostProcessor - 📋 === 详细分析报告 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a ===
15:21:20.980 [pool-2-thread-4] INFO  c.c.a.service.PostProcessor - 🎯 处理路由: 标准对话
15:21:20.980 [pool-2-thread-4] INFO  c.c.a.service.PostProcessor - 📊 质量评估: 总分={:.2f}, 完整性={:.2f}, 相关性={:.2f}, 清晰度={:.2f}, 效率={:.2f}
15:21:20.980 [pool-2-thread-4] INFO  c.c.a.service.PostProcessor - ⏱️ 性能统计: 预处理=0ms, 总处理=1ms
15:21:20.980 [pool-2-thread-4] INFO  c.c.a.service.PostProcessor - 💰 资源消耗: Tokens=0, 成本=0
15:21:20.980 [pool-2-thread-4] INFO  c.c.a.service.PostProcessor - 📋 === 分析报告结束 ===
15:21:20.980 [pool-2-thread-4] INFO  c.c.a.service.PostProcessor - ✅ 后处理完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 质量评分: {:.2f}, 耗时: 1.0ms
15:21:20.980 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - ✅ 后处理完成 - 耗时: 2ms
15:21:20.980 [pool-2-thread-4] INFO  c.c.a.service.AgentExecutor - 🎉 智能体执行完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总耗时: 8851ms
15:21:20.981 [http-nio-8081-exec-9] INFO  c.c.a.controller.StreamController - ✅ 流式聊天完成 - 会话: a832c85a-7a29-4c8e-9d01-dd03bc4d436a, 总处理时长: 8854ms
15:21:20.981 [http-nio-8081-exec-9] INFO  c.c.a.controller.StreamController - === 流式聊天请求结束 ===
