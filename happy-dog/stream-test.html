<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå¼è¾“å‡ºæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .response-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            min-height: 100px;
            border-left: 4px solid #667eea;
        }
        
        .stream-content {
            display: inline;
        }
        
        .stream-cursor {
            display: inline;
            animation: blink 1s infinite;
            color: #667eea;
            font-weight: bold;
            margin-left: 2px;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .streaming-complete .stream-cursor {
            display: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸš€ AIåŠ©æ‰‹æµå¼è¾“å‡ºæµ‹è¯•</h1>
        
        <div>
            <button class="test-button" onclick="testStream(false)">æµ‹è¯•æ™®é€šå¯¹è¯</button>
            <button class="test-button" onclick="testStream(true)">æµ‹è¯•æ·±åº¦æ€è€ƒ</button>
            <button class="test-button" onclick="clearResponse()">æ¸…é™¤ç»“æœ</button>
        </div>
        
        <div class="response-area" id="responseArea">
            ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•æµå¼è¾“å‡ºæ•ˆæœ...
        </div>
        
        <div style="margin-top: 20px; color: #666; font-size: 14px;">
            <h3>æµ‹è¯•è¯´æ˜ï¼š</h3>
            <ul>
                <li>ğŸ”µ æ™®é€šå¯¹è¯ï¼šæµ‹è¯•åŸºæœ¬çš„æµå¼æ–‡å­—è¾“å‡ºæ•ˆæœ</li>
                <li>ğŸ§  æ·±åº¦æ€è€ƒï¼šæµ‹è¯•æ€è€ƒæ­¥éª¤ + æµå¼æ–‡å­—çš„ç»„åˆæ•ˆæœ</li>
                <li>âš¡ è§‚å¯Ÿå…‰æ ‡é—ªçƒæ•ˆæœå’Œå®æ—¶æ–‡å­—æ›´æ–°</li>
                <li>âœ… å®Œæˆåå…‰æ ‡è‡ªåŠ¨æ¶ˆå¤±</li>
            </ul>
        </div>
    </div>

    <script>
        function testStream(enableDeepThinking) {
            const responseArea = document.getElementById('responseArea');
            const buttons = document.querySelectorAll('.test-button');
            
            // ç¦ç”¨æŒ‰é’®
            buttons.forEach(btn => btn.disabled = true);
            
            // æ¸…ç©ºå“åº”åŒºåŸŸ
            responseArea.innerHTML = enableDeepThinking ? 
                '<div style="color: #667eea;">ğŸ§  å¯åŠ¨æ·±åº¦æ€è€ƒæ¨¡å¼...</div>' : 
                '<div style="color: #667eea;">ğŸ’¬ å¯åŠ¨æ™®é€šå¯¹è¯æ¨¡å¼...</div>';
            
            const testMessage = enableDeepThinking ? 
                "è¯·è§£é‡Šä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†ç¨‹" : 
                "ä½ å¥½ï¼Œè¯·ç®€å•ä»‹ç»ä¸€ä¸‹è‡ªå·±";
            
            // å‘é€æµ‹è¯•è¯·æ±‚
            fetch('/api/stream/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'text/event-stream'
                },
                body: JSON.stringify({
                    message: testMessage,
                    sessionId: 'stream-test-' + Date.now(),
                    saveHistory: false,
                    enableDeepThinking: enableDeepThinking
                })
            })
            .then(response => {
                const reader = response.body.getReader();
                let currentMessage = '';
                let buffer = '';
                let hasContent = false;
                
                function processStream() {
                    return reader.read().then(({done, value}) => {
                        if (done) {
                            // å®Œæˆå¤„ç†
                            const streamElement = responseArea.querySelector('#streaming-content');
                            if (streamElement) {
                                streamElement.classList.add('streaming-complete');
                            }
                            buttons.forEach(btn => btn.disabled = false);
                            return;
                        }
                        
                        // è§£æSSEæ•°æ®
                        const chunk = new TextDecoder().decode(value);
                        buffer += chunk;
                        
                        const lines = buffer.split('\n');
                        buffer = lines.pop();
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const jsonData = line.substring(6).trim();
                                    if (jsonData === '') continue;
                                    const data = JSON.parse(jsonData);
                                    
                                    if (data.error) {
                                        responseArea.innerHTML = `<div style="color: red;">âŒ é”™è¯¯: ${data.error}</div>`;
                                        buttons.forEach(btn => btn.disabled = false);
                                        return;
                                    }
                                    
                                    if (data.done) {
                                        const streamElement = responseArea.querySelector('#streaming-content');
                                        if (streamElement) {
                                            streamElement.classList.add('streaming-complete');
                                        }
                                        buttons.forEach(btn => btn.disabled = false);
                                        return;
                                    }
                                    
                                    if (data.currentStep) {
                                        // æ˜¾ç¤ºæ€è€ƒæ­¥éª¤
                                        const stepDiv = document.createElement('div');
                                        stepDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 5px; border-left: 3px solid #2196f3;';
                                        stepDiv.innerHTML = `
                                            <strong>ğŸ§  ${data.currentStep.title}</strong><br>
                                            <span style="color: #666;">${data.currentStep.content}</span>
                                        `;
                                        responseArea.appendChild(stepDiv);
                                        
                                    } else if (data.content) {
                                        // å¤„ç†æµå¼å†…å®¹
                                        if (!hasContent) {
                                            hasContent = true;
                                            const contentDiv = document.createElement('div');
                                            contentDiv.id = 'streaming-content';
                                            contentDiv.innerHTML = `
                                                <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 5px;">
                                                    <strong>ğŸ’¬ AIå›å¤ï¼š</strong><br>
                                                    <span class="stream-content"></span><span class="stream-cursor">|</span>
                                                </div>
                                            `;
                                            responseArea.appendChild(contentDiv);
                                        }
                                        
                                        currentMessage += data.content;
                                        const contentElement = responseArea.querySelector('.stream-content');
                                        if (contentElement) {
                                            contentElement.textContent = currentMessage;
                                        }
                                    }
                                    
                                } catch (e) {
                                    console.error('è§£æJSONé”™è¯¯:', e);
                                }
                            }
                        }
                        
                        return processStream();
                    });
                }
                
                return processStream();
            })
            .catch(error => {
                responseArea.innerHTML = `<div style="color: red;">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
                buttons.forEach(btn => btn.disabled = false);
            });
        }
        
        function clearResponse() {
            const responseArea = document.getElementById('responseArea');
            responseArea.innerHTML = 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•æµå¼è¾“å‡ºæ•ˆæœ...';
        }
    </script>
</body>
</html>
